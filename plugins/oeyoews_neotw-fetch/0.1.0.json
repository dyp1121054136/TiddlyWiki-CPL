{"title":"$:/plugins/oeyoews/neotw-fetch","description":"Neotw Fetch","author":"oeyoews","version":"0.1.0","core-version":">=5.3.1","type":"application/json","plugin-type":"plugin","name":"Neotw Fetch","dependents":"$:/plugins/oeyoews/tiddlywiki-tailwindcss-plus","list":"readme","text":"{\"tiddlers\":{\"$:/plugins/oeyoews/neotw-fetch/readme\":{\"title\":\"$:/plugins/oeyoews/neotw-fetch/readme\",\"text\":\"!! Getfile\\n\\n\\n!! TODO\\n\\n* [ ] 借鉴tw的tm-http\\n* [ ] markdown img语法会残留tc-imag-loading\"},\"$:/plugins/oeyoews/neotw-fetch/addfile.js\":{\"title\":\"$:/plugins/oeyoews/neotw-fetch/addfile.js\",\"text\":\"/*\\\\\\ntitle: $:/plugins/oeyoews/neotw-fetch/addfile.js\\ntype: application/javascript\\nmodule-type: library\\n\\n仅支持简单的两层数据嵌套\\n\\\\*/\\nexports.addfile = (url, filename, type = 'text') => {\\n  fetch(url)\\n    .then((res) => {\\n      if (!res.ok) return;\\n      return res[type]();\\n    })\\n    .then((data) => {\\n      if (!data) return;\\n      if ($tw.wiki.tiddlerExists(filename)) {\\n        console.warn(`${filename} 已存在`);\\n        return;\\n      }\\n      $tw.wiki.addTiddler({\\n        title: filename,\\n        type: 'text/markdown',\\n        text: data,\\n      });\\n    });\\n};\\n\\n// cache\\nexports.getText = (url) => {\\n  return fetch(url).then((res) => {\\n    if (!res.ok) return;\\n    return res.text();\\n  });\\n};\\n\",\"type\":\"application/javascript\",\"module-type\":\"library\"},\"$:/plugins/oeyoews/neotw-fetch/startup.js\":{\"title\":\"$:/plugins/oeyoews/neotw-fetch/startup.js\",\"text\":\"/*\\\\\\ntitle: $:/plugins/oeyoews/neotw-fetch/startup.js\\ntype: application/javascript\\nmodule-type: startup\\n\\nfetch-readme module\\n\\\\*/\\nexports.name = 'fetch-readme-startup-hook';\\nexports.platforms = ['browser'];\\nexports.after = ['startup'];\\nexports.synchronous = true;\\n\\nexports.startup = () => {\\n  const { addfile } = require('./addfile');\\n  $tw.rootWidget.addEventListener('om-fetch', (event) => {\\n    const time = new Date().getTime();\\n    const {\\n      paramObject: {\\n        url = 'https://raw.githubusercontent.com/oeyoews/neotw/main/README.md',\\n        fileName = `fetch-${time}`,\\n      } = {},\\n    } = event;\\n    addfile(url, fileName);\\n  });\\n};\\n\",\"type\":\"application/javascript\",\"module-type\":\"startup\"},\"$:/plugins/oeyoews/neotw-fetch/widget.js\":{\"title\":\"$:/plugins/oeyoews/neotw-fetch/widget.js\",\"text\":\"/*\\\\\\ntitle: $:/plugins/oeyoews/neotw-fetch/widget.js\\ntype: application/javascript\\nmodule-type: widget\\n\\nfetch-mdfile widget\\n\\\\*/\\nconst Widget = require('$:/core/modules/widgets/widget.js').widget;\\nconst { getText } = require('./addfile');\\n\\nclass FetchWidget extends Widget {\\n  constructor(parseTreeNode, options) {\\n    super(parseTreeNode, options);\\n  }\\n\\n  render(parent, nextSibling) {\\n    if (!$tw.browser) return;\\n    this.parentDomNode = parent;\\n    this.computeAttributes();\\n    this.execute();\\n\\n    if (!$tw.modules.titles['nprogress.min.js']) {\\n      const notify = new $tw.Notify();\\n      notify.display({\\n        title: 'neotw-fetch',\\n        status: 'warning',\\n        autoclose: false,\\n        type: 1,\\n        text: '缺失 NProgress 插件',\\n      });\\n    }\\n    const progress = new $tw.NProgress();\\n\\n    const defaulturl =\\n      'https://raw.githubusercontent.com/oeyoews/neotw/main/README.md';\\n\\n    const { url = defaulturl } = this.attributes;\\n\\n    const domNode = this.document.createElement('div');\\n\\n    getText(url).then((text) => {\\n      if (!text) console.log('text null');\\n      progress.start();\\n      const textContent = $tw.wiki.renderText(\\n        'text/html',\\n        'text/markdown',\\n        text,\\n      );\\n      domNode.innerHTML = textContent;\\n      progress.done();\\n    });\\n\\n    parent.insertBefore(domNode, nextSibling);\\n    this.domNodes.push(domNode);\\n  }\\n  refresh() {\\n    return false;\\n  }\\n}\\n\\nexports['fetch'] = FetchWidget;\\n\",\"type\":\"application/javascript\",\"module-type\":\"widget\"}}}"}