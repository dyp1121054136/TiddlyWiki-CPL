{"author":"whitefall","core-version":">=5.2.0","dependents":"$:/plugins/tiddlywiki/markdown","description":"从 Obsidian 笔记库导入 Markdown 文件到 TiddlyWiki","list":"readme ui/Panel ui/settings","name":"Obsidian Vault","plugin-type":"plugin","text":"{\"tiddlers\":{\"$:/config/markdown/breaks\":{\"title\":\"$:/config/markdown/breaks\",\"created\":\"20230915033254554\",\"modified\":\"20230915033254554\",\"type\":\"text/vnd.tiddlywiki\",\"text\":\"true\"},\"$:/plugins/whitefall/obsidian-vault/readme\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/readme\",\"type\":\"text/vnd.tiddlywiki\",\"text\":\"! tw5-obsidian-vault\\n\\n使用方式请查看：[[参考手册|https://tiddly-gittly.github.io/tidgi-obsidian-manager/]]\\n\\nGithub Repo: https://github.com/tiddly-gittly/tidgi-obsidian-manager\"},\"$:/plugins/whitefall/obsidian-vault/router/get-obvault.js\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/router/get-obvault.js\",\"text\":\"!function(){\\\"use strict\\\";exports.method=\\\"GET\\\",exports.path=/^\\\\/obvault\\\\/(.+)$/,exports.handler=function(e,t,c){var b=require(\\\"path\\\"),h=require(\\\"fs\\\"),i=$tw.utils.decodeURIComponentSafe(c.params[0]),s=c.queryParameters,y=function(e,t){return e=e.replace(/\\\\\\\\/g,\\\"/\\\"),(t=t.replace(/\\\\\\\\/g,\\\"/\\\")).slice(e.length+1)},i=function(e,t,i){var i=i||[\\\".git\\\",\\\".obsidian\\\"],s={obVaultName:e.split(\\\"/\\\").pop()||\\\"-\\\",mdFiles:{},imgFiles:{},bp_peer:{}},n=t||\\\"\\\";if(!h.statSync(e).isDirectory())return c.sendResponse(400,{\\\"Content-Type\\\":\\\"text/plain\\\"},\\\"Not folder: \\\"+e),!1;for(var a=[e];0!==a.length;){var r=a.pop();for(const f of h.readdirSync(r)){var p,o,d,l,g,m,u=b.join(r,f);h.statSync(u).isFile()?(o=f.lastIndexOf(\\\".\\\"),p=f.substring(0,o),o=f.substring(o+1),-1!==[\\\"jpg\\\",\\\"jpeg\\\",\\\"png\\\",\\\"gif\\\",\\\"bmp\\\",\\\"svg\\\"].indexOf(o)?s.imgFiles[p]?s.imgFiles[p].push({path:y(e,u),data:h.readFileSync(u).toString(\\\"base64\\\"),basename:p,extension:o}):s.imgFiles[p]=[{path:y(e,u),data:h.readFileSync(u).toString(\\\"base64\\\"),basename:p,extension:o}]:\\\"md\\\"===o&&(d=u.lastIndexOf(\\\".\\\"),d=u.substring(0,d),l=h.readFileSync(u,\\\"utf8\\\"),g=h.statSync(u),m=RegExp(n),s.bp_peer[p]?s.bp_peer[p].push(y(e,d)):s.bp_peer[p]=[y(e,d)],m.test(l))&&(s.mdFiles[p]?s.mdFiles[p].push({path:y(e,d),data:l,created:$tw.utils.stringifyDate(g.birthtime),modified:$tw.utils.stringifyDate(g.mtime),basename:p,extension:o}):s.mdFiles[p]=[{path:y(e,d),data:l,created:$tw.utils.stringifyDate(g.birthtime),modified:$tw.utils.stringifyDate(g.mtime),basename:p,extension:o}])):i.includes(f)||a.push(u)}}return s}(i,s.regText,s.ignore);0!=i&&(s=JSON.stringify(i),c.sendResponse(200,{\\\"Content-Type\\\":\\\"application/json\\\"},s))}}();\",\"type\":\"application/javascript\",\"module-type\":\"route\"},\"$:/plugins/whitefall/obsidian-vault/stylesheet/obsidian-main-style\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/stylesheet/obsidian-main-style\",\"tags\":\"$:/tags/Stylesheet\",\"type\":\"text/css\",\"text\":\".obvault-control-panel td{padding:4px}.obvault-control-panel table,.obvault-control-panel table input,.obvault-control-panel table textarea{width:100%}.list-obvault-scroll-container{border:2px solid #ccc;border-radius:5px;height:100px;max-height:200px;overflow-y:scroll}\"},\"$:/plugins/whitefall/obsidian-vault/ui/Panel\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/ui/Panel\",\"type\":\"text/vnd.tiddlywiki\",\"tags\":\"$:/tags/ControlPanel/SettingsTab\",\"caption\":\"obvault-Panel\",\"text\":\"\\n<$obvault/>\\n<div class=\\\"obvault-control-panel\\\">\\n<table>\\n    <tr>\\n        <th>Vault 文件夹路径</th>\\n    </tr>\\n    <tr>\\n        <td><$edit-text tiddler=\\\"$:/temp/obsidian-vault/input-box-path\\\" size=\\\"48\\\" type=\\\"text\\\" tag=\\\"input\\\" default=\\\"\\\" placeholder=\\\"请输入路径\\\" focus={{$:/plugins/whitefall/obsidian-vault/config/AutoFocus}} /></td>\\n    </tr>\\n</table>\\n\\n<table>\\n  <tr>\\n    <th>选中文件</th>\\n    <th>排除文件夹</th>\\n  </tr>\\n  <tr>\\n    <td><$edit-text tiddler=\\\"$:/temp/obsidian-vault/input-box-reg\\\" type=\\\"text\\\" tag=\\\"input\\\" default=\\\"\\\" placeholder=\\\"请输入表达式\\\" focus={{$:/plugins/whitefall/obsidian-vault/config/AutoFocus}} /></td>\\n    <td><$edit-text tiddler=\\\"$:/temp/obsidian-vault/input-box-ignore\\\" type=\\\"text\\\" tag=\\\"input\\\" default=\\\"\\\" placeholder=\\\"请输入表达式\\\" focus={{$:/plugins/whitefall/obsidian-vault/config/AutoFocus}} /></td>\\n  </tr>\\n</table>\\n</div>\\n\\n\\n<$set name='path' tiddler='$:/temp/obsidian-vault/input-box-path'>\\n<$set name='reg' tiddler='$:/temp/obsidian-vault/input-box-reg'>\\n<$set name='ignore' tiddler='$:/temp/obsidian-vault/input-box-ignore'>\\n  <$button><$action-sendmessage $message=\\\"tw-obsidian-add\\\" path=<<path>> reg=<<reg>> ignore=<<ignore>> />add</$button>\\n  <$button><$action-sendmessage $message=\\\"tw-obsidian-purge\\\" />purge</$button>\\n</$set>\\n</$set>\\n</$set>\\n\\n<details>\\n  <summary>Vault List</summary>\\n  <div class=\\\"list-obvault-scroll-container\\\">\\n    <$list filter=\\\"[get[obvault]unique[]]\\\" variable=\\\"list-obvault\\\">\\n      <div class=\\\"list-obvault-container\\\">\\n        <input type=\\\"text\\\" value=<<list-obvault>> disabled=\\\"disabled\\\">\\n        <$button><$action-sendmessage $message=\\\"tw-obsidian-sync\\\" obvault=<<list-obvault>> />Sync</$button>\\n        <$button><$action-sendmessage $message=\\\"tw-obsidian-delete\\\" obvault=<<list-obvault>> />Delete</$button>\\n      </div>\\n    </$list>\\n  </div>\\n  <$link to=\\\"$:/status/obsidian-vault/vault-rw-config\\\">vault-rw-config</$link>\\n</details>\\n\"},\"$:/plugins/whitefall/obsidian-vault/ui/displayCaption\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/ui/displayCaption\",\"text\":\"\\\\whitespace trim\\n<h2 class=\\\"tc-title\\\">\\n{{!!caption}}\\n</h2>\"},\"$:/plugins/whitefall/obsidian-vault/ui/displayCaptionFilter\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/ui/displayCaptionFilter\",\"tags\":\"$:/tags/ViewTemplateTitleFilter\",\"list-before\":\"$:/config/ViewTemplateTitleFilters/default\",\"text\":\"[<currentTiddler>has[obvault]has[caption]then[$:/plugins/whitefall/obsidian-vault/ui/displayCaption]]\"},\"$:/plugins/whitefall/obsidian-vault/ui/settings\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/ui/settings\",\"tags\":\"$:/tags/ControlPanel/SettingsTab\",\"caption\":\"obvault settings\",\"text\":\"<$checkbox tiddler=\\\"$:/config/markdown/breaks\\\" field=\\\"text\\\" checked=\\\"true\\\" unchecked=\\\"false\\\" default=\\\"true\\\"> [[Breaks|$:/config/markdown/breaks]], 适配obsidian风格硬换行格式, 需要刷新页面后生效。</$checkbox> \\n\"},\"$:/plugins/whitefall/obsidian-vault/ui/vaulttrees\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/ui/vaulttrees\",\"tags\":\"$:/tags/SideBar\",\"caption\":\"VaultTrees\",\"text\":\"\\n<div class=\\\"tc-tree-obv\\\">\\n<span><center><p>Obsidian Vault<sup><$link to=\\\"$:/plugins/whitefall/obsidian-vault/ui/Panel\\\">p</$link></sup>&nbsp;文件列表</p></center></span>\\n<<tree prefix:\\\"λ:/\\\">>\\n</div>\\n\\n<!-- \\n[get[obvault]unique[]]\\n[field:obvault[Neural-Networks]get[vaulttree]]\\n条目名必须和字段路径中的名字一致。\\n-->\\n\"},\"$:/plugins/whitefall/obsidian-vault/obvault-main.js\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/obvault-main.js\",\"type\":\"application/javascript\",\"module-type\":\"widget\",\"Modern.TiddlyDev#Origin\":\"obvault-main.ts\",\"text\":\"\\\"use strict\\\";var import_widget=require(\\\"$:/core/modules/widgets/widget.js\\\");function tm_notify(t,e){$tw.wiki.addTiddler({title:\\\"$:/state/notification/\\\"+t,text:t+\\\": \\\"+e}),$tw.notifier.display(\\\"$:/state/notification/\\\"+t)}async function fetchData(t,e,i){var a,n=[\\\".git\\\",\\\".obsidian\\\",\\\".stfolder\\\",\\\".stversions\\\"],n=(\\\"\\\"===i&&(a=JSON.stringify(n)),\\\"\\\"===i&&\\\"+\\\"!==i.at(0)||(r=i.substring(1).replace(/[ ]/g,\\\"\\\").split(\\\",\\\"),a=JSON.stringify(n.concat(r))),\\\"\\\"!==i&&\\\"+\\\"!==i.at(0)&&(r=i.replace(/[ ]/g,\\\"\\\").split(\\\",\\\"),a=JSON.stringify(r)),$tw.wiki.getTiddlerText(\\\"$:/info/url/full\\\")),r=n+\\\"obvault/\\\"+t+`?regText=${e}&ignore=`+a,n=(console.log(\\\"获取数据: \\\"+r),tm_notify(\\\"获取数据: \\\",`\\\"${r.toString()}\\\"`),await fetch(r));if(400!=n.status)return a=await n.json(),console.log(\\\"获取完成, 正在写入到wiki中。\\\"),tm_notify(\\\"获取数据: \\\",\\\"获取完成, 正在写入到wiki中\\\"),a;tm_notify(\\\"获取数据: \\\",\\\"Not Folder\\\")}function isUrl(t){return new RegExp(\\\"^(?!mailto:)(?:(?:http|https|ftp)://|//)(?:\\\\\\\\S+(?::\\\\\\\\S*)?@)?(?:(?:(?:[1-9]\\\\\\\\d?|1\\\\\\\\d\\\\\\\\d|2[01]\\\\\\\\d|22[0-3])(?:\\\\\\\\.(?:1?\\\\\\\\d{1,2}|2[0-4]\\\\\\\\d|25[0-5])){2}(?:\\\\\\\\.(?:[0-9]\\\\\\\\d?|1\\\\\\\\d\\\\\\\\d|2[0-4]\\\\\\\\d|25[0-4]))|(?:(?:[a-z\\\\\\\\u00a1-\\\\\\\\uffff0-9]+-?)*[a-z\\\\\\\\u00a1-\\\\\\\\uffff0-9]+)(?:\\\\\\\\.(?:[a-z\\\\\\\\u00a1-\\\\\\\\uffff0-9]+-?)*[a-z\\\\\\\\u00a1-\\\\\\\\uffff0-9]+)*(?:\\\\\\\\.(?:[a-z\\\\\\\\u00a1-\\\\\\\\uffff]{2,})))|localhost)(?::\\\\\\\\d{2,5})?(?:(/|\\\\\\\\?|#)[^\\\\\\\\s]*)?$\\\",\\\"i\\\").test(t)}function unique_or_root_link(t,e){if(!(t in e))return\\\"\\\";var i=e[t];if(1===i.length){var a=i[0];if(a)return a}if(1<i.length)for(const r in i){var n=i[r];if(!n.includes(\\\"/\\\"))return n}}function links_wiki_syntax(t,e,i){var a={pattern:new RegExp(\\\"(?<!!)\\\\\\\\[\\\\\\\\[(.*?)\\\\\\\\]\\\\\\\\]\\\",\\\"g\\\"),target:\\\"[[$1]]\\\"},n=(new RegExp(\\\"(?<!!)\\\\\\\\[(.*?)\\\\\\\\]\\\\\\\\((.*?)\\\\\\\\)\\\",\\\"g\\\"),[...t.matchAll(a.pattern)]);for(const s in n){var r=n[s][1],l=n[s][0],r=r.split(\\\"|\\\"),o=r[0];if(1===r.length){if(isUrl(o))break;!isUrl(o)&&o.includes(\\\"/\\\")&&(t=t.replace(l,\\\"[[\\\"+r[0].split(\\\"/\\\").slice(-1)+\\\"|λ:/\\\"+i+\\\"/\\\"+r[0]+\\\"]]\\\"));var d=unique_or_root_link(o,e);\\\"\\\"!==d&&(t=t.replace(l,\\\"[[\\\"+r[0]+\\\"|λ:/\\\"+i+\\\"/\\\"+d+\\\"]]\\\"))}1<r.length&&(isUrl(o)&&(t=t.replace(l,\\\"[[\\\"+r[1]+\\\"|\\\"+r[0]+\\\"]]\\\")),!isUrl(o)&&o.includes(\\\"/\\\")&&(t=t.replace(l,\\\"[[\\\"+r[1]+\\\"|λ:/\\\"+i+\\\"/\\\"+r[0]+\\\"]]\\\")),\\\"\\\"!==(d=unique_or_root_link(o,e)))&&(t=t.replace(l,\\\"[[\\\"+r[1]+\\\"|λ:/\\\"+i+\\\"/\\\"+d+\\\"]]\\\"))}return t}function embeds_wiki_syntax(t,n,r){return t=(t=t.replace(/\\\\!\\\\[\\\\[(.*?)\\\\]\\\\]/g,(t,e)=>{var i=e.split(\\\"|\\\"),a=i[0].split(\\\".\\\").slice(-1)[0].trim();if(-1===[\\\"jpg\\\",\\\"jpeg\\\",\\\"png\\\",\\\"gif\\\",\\\"bmp\\\",\\\"svg\\\"].indexOf(a)){if(1===i.length){a=unique_or_root_link(i[0],n);if(\\\"\\\"!==a)return\\\"{{λ:/\\\"+r+\\\"/\\\"+a+\\\"}}\\\"}return\\\"{{\\\"+e+\\\"}}\\\"}if(1===i.length)return\\\"[img [\\\"+i[0].trim()+\\\"]]\\\";if(1<i.length){a=+i.slice(-1)[0];if(\\\"number\\\"==typeof a)return\\\"[img width=\\\"+a+\\\" [\\\"+i[0].trim()+\\\"]]\\\"}})).replace(/\\\\!\\\\[(.*?)\\\\]\\\\((.*?)\\\\)/g,(t,e,i)=>{var a=e.split(\\\"|\\\"),n=i,r=n.split(\\\".\\\").slice(-1)[0].trim();if(-1===[\\\"jpg\\\",\\\"jpeg\\\",\\\"png\\\",\\\"gif\\\",\\\"bmp\\\",\\\"svg\\\",\\\"ico\\\"].indexOf(r))return t;if(0===a.length||\\\"\\\"===a[0].trim())return\\\"[img [\\\"+n+\\\"]]\\\";if(1===a.length)return\\\"[img [\\\"+a[0].trim()+\\\"|\\\"+n+\\\"]]\\\";if(1<a.length){r=+a.slice(-1)[0].split(\\\"x\\\")[0];if(\\\"number\\\"==typeof r)return\\\"[img width=\\\"+r+\\\" [\\\"+a[0].trim()+\\\"|\\\"+n+\\\"]]\\\"}})}function bold_wiki_syntax(t){return t=t.replace(/\\\\x20*\\\\*\\\\*(.*?)\\\\*\\\\*\\\\x20*/g,\\\" **$1** \\\")}async function convert(t,e,i){return t=void 0!==t&&0!==t.length?bold_wiki_syntax(t=links_wiki_syntax(t=embeds_wiki_syntax(t,e,i),e,i)):t}async function addVault(t){console.log(\\\"vaultName: \\\"+t.obVaultName);var e=$tw.wiki.getTiddlerText(\\\"$:/status/UserName\\\");console.log(t);for(const p in t.mdFiles){var i=t.mdFiles[p];if(0!=i.length&&1==i.length){var a=i[0],n=await convert(a.data,t.bp_peer,t.obVaultName),r=`λ:/${t.obVaultName}/`+a.path;$tw.wiki.addTiddler(new $tw.Tiddler({title:r,type:\\\"text/markdown\\\",caption:a.basename,created:a.created,modified:a.modified,modifier:e,text:n,obvault:t.obVaultName}))}else if(1<i.length)for(const m in i){var l=i[m],o=await convert(l.data,t.bp_peer,t.obVaultName),d=`λ:/${t.obVaultName}/`+l.path;$tw.wiki.addTiddler(new $tw.Tiddler({title:d,type:\\\"text/markdown\\\",caption:l.basename,created:l.created,modified:l.modified,modifier:e,text:o,obvault:t.obVaultName}))}}for(const v in t.imgFiles){var s=t.imgFiles[v];if(0!=s.length&&1==s.length){var u=s[0],f=u.basename+\\\".\\\"+u.extension,u=\\\"image/\\\"+u.extension;$tw.wiki.addTiddler(new $tw.Tiddler({title:f,type:u,text:s[0].data,obvault:t.obVaultName}))}else if(1<s.length)for(const b in s){var g=s[b],c=g.path,w=\\\"image/\\\"+g.extension;$tw.wiki.addTiddler(new $tw.Tiddler({title:c,type:w,text:g.data,obvault:t.obVaultName}))}}console.log(\\\"addVault: 所有添加工作已完成。\\\"),tm_notify(\\\"addVault\\\",\\\"所有添加工作已完成，请等待【文件系统同步服务】完成任务。\\\")}async function purgeVault(t){var e;console.log(\\\"purgeVault: \\\"+t),\\\"\\\"!==t&&(e=$tw.wiki.filterTiddlers(`[field:obvault[${t}]]`),tm_notify(\\\"purgeVault\\\",`正在清空${t}Vault`),await deleteTiddler(e)),void 0!==t&&\\\"\\\"!==t||await deleteTiddler($tw.wiki.filterTiddlers(\\\"[has:field[obvault]]\\\"))}async function deleteTiddler(t){0!==t.length?(t.forEach(t=>{console.log(\\\"删除条目：\\\"+t),$tw.wiki.deleteTiddler(t)}),tm_notify(\\\"purgeVault\\\",\\\"所有删除工作已完成, 请等待【文件系统同步服务】完成任务。\\\")):tm_notify(\\\"purgeVault\\\",\\\"未曾添加Obsidian仓库, 写入记录为空。\\\")}var CONFIG_FILE=\\\"$:/status/obsidian-vault/vault-rw-config\\\";function getConfig(){var t=$tw.wiki.getTiddlerText(CONFIG_FILE);if(void 0===t)return{};try{return JSON.parse(t)}catch(e){return console.log(\\\"解析JSON失败, 不是正确的JSON格式!\\\"),console.log(e),$tw.wiki.deleteTiddler(CONFIG_FILE),{}}}function addConfig(t){var e={...getConfig(),...t};$tw.wiki.addTiddler(new $tw.Tiddler({title:CONFIG_FILE,text:JSON.stringify(e)}))}function getConfigJSON(){return getConfig()}function deleteConfig(t){var e=$tw.wiki.getTiddlerText(CONFIG_FILE);void 0!==e&&(delete(e=JSON.parse(e))[t],$tw.wiki.addTiddler(new $tw.Tiddler({title:CONFIG_FILE,text:JSON.stringify(e)}))),void 0!==t&&\\\"\\\"!==t||$tw.wiki.deleteTiddler(CONFIG_FILE)}var ObVaultServer=class{constructor(){$tw.rootWidget.addEventListener(\\\"tw-obsidian-add\\\",async t=>{await this.getAndWrite(t.paramObject.path,t.paramObject.reg,t.paramObject.ignore)}),$tw.rootWidget.addEventListener(\\\"tw-obsidian-purge\\\",async t=>{purgeVault(),deleteConfig()}),$tw.rootWidget.addEventListener(\\\"tw-obsidian-sync\\\",async t=>{var e=t.paramObject.obvault,i=getConfigJSON();\\\"{}\\\"!==JSON.stringify(i)?(console.log(\\\"开始更新Vault。\\\"),tm_notify(\\\"Vault-Sync\\\",\\\"开始更新Vault。\\\"),purgeVault(e),await this.getAndWrite(i[e].path,i[e].reg,i[e].ignore)):(console.log(\\\"更新失败, CONFIG_FILE为空。重新添加Vault后, 将自动生成记录\\\"),tm_notify(\\\"Vault-Sync\\\",\\\"更新失败, CONFIG_FILE为空。重新添加Vault后, 将自动生成记录\\\"))}),$tw.rootWidget.addEventListener(\\\"tw-obsidian-delete\\\",async t=>{var e=t.paramObject.obvault;console.log(\\\"删除Vault: \\\"+e),tm_notify(\\\"Vault-Delete\\\",\\\"删除Vault: \\\"+e),purgeVault(e),deleteConfig(e)})}async getAndWrite(t,e,i){var a,n,r;this.isValidPath(t)&&(a=await fetchData(t,e,i),n={},r=this.getFolderName(t),void 0!==a)&&(n[r]={path:t,reg:e,ignore:i},addVault(a),addConfig(n))}isValidPath(t){return\\\"\\\"===t?(console.log(\\\"路径为空！\\\"),tm_notify(\\\"addVault\\\",\\\"路径为空！\\\"),!1):!!/^(\\\\/|\\\\.\\\\.?\\\\/|([A-Za-z]:)?[\\\\\\\\|\\\\/])[^\\\\\\\\|\\\\/]+([\\\\\\\\|\\\\/][^\\\\\\\\|\\\\/]+)*[\\\\\\\\|\\\\/]?$/.test(t)||(console.log(\\\"无效路径！\\\"),tm_notify(\\\"addVault\\\",\\\"无效路径！\\\"),!1)}getFolderName(t){var e=t.lastIndexOf(\\\"/\\\"),i=t.lastIndexOf(\\\"\\\\\\\\\\\"),e=Math.max(e,i);return e<0?t:t.substring(e+1)}},ObVaultWidget=class extends import_widget.widget{refresh(t){this.computeAttributes();return!1}async render(t,e){this.parentDomNode=t,this.execute();new ObVaultServer}};exports.obvault=ObVaultWidget;\"}}}","title":"$:/plugins/whitefall/obsidian-vault","type":"application/json","version":"0.1.3","Modern.TiddlyDev#SHA256-Hashed":"42103bf42cffef6b46b34fba419615ee469605eff65815135d5a401763c23815"}