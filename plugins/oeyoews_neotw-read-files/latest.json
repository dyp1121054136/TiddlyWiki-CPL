{"title":"$:/plugins/oeyoews/neotw-read-files","description":"扩展TiddlyWiki读取目录","author":"oeyoews","version":"0.0.1","core-version":">=5.3.0","type":"application/json","plugin-type":"plugin","name":"Neotw Read Files","dependents":"","list":"readme","text":"{\"tiddlers\":{\"$:/plugins/oeyoews/neotw-read-files/Action\":{\"title\":\"$:/plugins/oeyoews/neotw-read-files/Action\",\"tags\":\"$:/tags/StartupAction/PostRender\",\"text\":\"<$list filter=\\\"[{$:/info/url/search}match[?layout=neotw-read-files]]\\\">\\n  <$action-setfield $tiddler=\\\"$:/layout\\\" text=\\\"$:/plugins/oeyoews/neotw-read-files/Layout\\\"/>\\n</$list>\"},\"$:/plugins/oeyoews/neotw-read-files/Layout\":{\"title\":\"$:/plugins/oeyoews/neotw-read-files/Layout\",\"tags\":\"$:/tags/Layout\",\"name\":\"{{$:/plugins/oeyoews/neotw-read-files/icon}}\",\"description\":\"{{$:/plugins/oeyoews/neotw-read-files/readme!!description}}\",\"text\":\"\\\\import [[$:/core/ui/PageMacros]] [all[shadows+tiddlers]tag[$:/tags/Macro]!has[draft.of]]\\n\\n<$vars\\n\\ttv-config-toolbar-icons={{$:/config/Toolbar/Icons}}\\n\\ttv-config-toolbar-text={{$:/config/Toolbar/Text}}\\n\\ttv-config-toolbar-class={{$:/config/Toolbar/ButtonClass}}\\n\\ttv-enable-drag-and-drop={{$:/config/DragAndDrop/Enable}}\\n\\ttv-show-missing-links={{$:/config/MissingLinks}}\\n\\tstoryviewTitle={{$:/view}}\\n\\tlanguageTitle={{{ [{$:/language}get[name]] }}}>\\n\\n<div class=\\\"prose max-w-none prose-indigo m-auto sm:w-auto md:w-2/3\\\">\\n  {{{ [[$:/plugins/oeyoews/neotw-read-files/readme]] ||$:/core/ui/ViewTemplate }}}\\n</div>\"},\"$:/plugins/oeyoews/neotw-read-files/readme\":{\"title\":\"$:/plugins/oeyoews/neotw-read-files/readme\",\"description\":\"\",\"text\":\"{{$:/languages/neotw-read-files/readme}}\\n\"},\"$:/languages/neotw-read-files/readme\":{\"title\":\"$:/languages/neotw-read-files/readme\",\"type\":\"text/markdown\",\"text\":\"<div class=\\\"prose max-w-none prose-indigo\\\">\\n\\n* [[Source|https://github.com/oeyoews/neotw/tree/main/plugins/oeyoews/neotw-read-files]]\\n* [[Demo|https://oeyoews.github.io/neotw]]\\n\\n* 支持读取images文件夹, 不受 markdown 或者 wikitext 语法限制, 下面使用 markdown 语法演示\\n* 默认支持static目录, 编辑 [自定义目录](#$:/plugins/oeyoews/neotw-read-files/custom-path) 文件自定义目录\\n\\n## usage\\n\\n```bash\\n![xxx](./static/xxx)\\n<object data=\\\"files/test.pdf\\\" type=\\\"application/pdf\\\" class=\\\"h-screen w-full\\\" />\\n\\n <embed src=\\\"./files/test.pdf\\\" type=\\\"application/pdf\\\" class=\\\"h-screen w-full\\\">\\n```\\n\\n* 更多外部文件使用方式参考官方文档或者 https://keatonlao.github.io/tiddlywiki-xp/#%E6%96%B0%E6%89%8B%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97\\n\\n</div>\"},\"$:/plugins/oeyoews/neotw-read-files/routes/get-file.js\":{\"title\":\"$:/plugins/oeyoews/neotw-read-files/routes/get-file.js\",\"text\":\"/*\\\\\\ntitle: $:/plugins/oeyoews/neotw-read-files/routes/get-file.js\\ntype: application/javascript\\nmodule-type: route\\n\\nneotw-read-files GET /images/:filepath\\n由 https://github.com/Jermolene/TiddlyWiki5/blob/ceee20fd5970e1b75c2117d2522c998a6c5054f3/core/modules/server/routes/get-file.js 改写\\n\\n\\\\*/\\n(function () {\\n  /*jslint node: true, browser: true */\\n  /*global $tw: false */\\n  'use strict';\\n\\n  exports.method = 'GET';\\n\\n  // exports.path = /^\\\\/static\\\\/(.+)$/;\\n  const customPath =\\n    $tw.wiki.getTiddlerText(\\n      '$:/plugins/oeyoews/neotw-read-files/custom-path',\\n    ) || 'static';\\n  exports.path = new RegExp(`^/${customPath}/(.+)`);\\n\\n  exports.handler = function (request, response, state) {\\n    var path = require('path'),\\n      fs = require('fs'),\\n      util = require('util'),\\n      suppliedFilename = $tw.utils.decodeURIComponentSafe(state.params[0]),\\n      baseFilename = path.resolve(state.boot.wikiPath, customPath),\\n      filename = path.resolve(baseFilename, suppliedFilename),\\n      extension = path.extname(filename);\\n    // Check that the filename is inside the wiki files folder\\n    if (path.relative(baseFilename, filename).indexOf('..') !== 0) {\\n      // Send the file\\n      fs.readFile(filename, function (err, content) {\\n        var status,\\n          content,\\n          type = 'text/plain';\\n        if (err) {\\n          console.log(\\n            'Error accessing file ' + filename + ': ' + err.toString(),\\n          );\\n          status = 404;\\n          content = \\\"File '\\\" + suppliedFilename + \\\"' not found\\\";\\n        } else {\\n          status = 200;\\n          content = content;\\n          type = $tw.config.fileExtensionInfo[extension]\\n            ? $tw.config.fileExtensionInfo[extension].type\\n            : 'application/octet-stream';\\n        }\\n        state.sendResponse(status, { 'Content-Type': type }, content);\\n      });\\n    } else {\\n      state.sendResponse(\\n        404,\\n        { 'Content-Type': 'text/plain' },\\n        \\\"File '\\\" + suppliedFilename + \\\"' not found\\\",\\n      );\\n    }\\n  };\\n})();\\n\",\"type\":\"application/javascript\",\"module-type\":\"route\"}}}"}